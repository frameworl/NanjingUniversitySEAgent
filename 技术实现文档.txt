南大软件学院 SE 流程智能体 — 技术实现文档
版本：v1.0
日期：2025-11-10

一、架构总览
- 模块分层：
  1) 数据采集与清洗（Ingestion）：文件抓取、OCR、格式规整、元数据抽取
  2) 索引构建（Indexing）：分块策略、嵌入生成、倒排索引、向量库写入
  3) 检索（Retrieval）：混合检索（BM25 + 语义向量）、聚合与Top-K候选
  4) 重排与过滤（Rerank & Filter）：交叉编码器重排、去重、基于元数据过滤
  5) 记忆（Memory）：短期会话窗口、长期记忆库（语义摘要/主题桶/时间衰减）
  6) 工具调用（Tools via MCP）：模板下载、清单生成、日程/消息、文档校验、协作平台
  7) 推理编排（Orchestration via DSL）：以DSL定义与驱动端到端工作流
  8) 接口与发布（API & Publish）：REST API、华为平台、阿里云百炼发布

- 技术栈建议：
  - 语言与框架：Python（FastAPI/Flask）或Node.js（Express），结合RAG框架（LangChain/LlamaIndex）
  - 向量库：Qdrant（简洁、过滤丰富）或 Milvus；词法检索：Elasticsearch/OpenSearch
  - 模型托管：本地/云端混合；华为云/阿里云模型服务；推理层可用开源大模型或平台模型API
  - 存储：PostgreSQL/SQLite（元数据与会话）、对象存储（原文档与截图）
  - 监控：Prometheus + Grafana，或平台内置观测

二、RAG技术选型与理由
1) 索引模式
   - 文档分块（Chunking）：
     - 结构化分块：依据标题层级（H1-H3）、列表、表格划分，保留章节路径（用于可解释输出）
     - 滑窗补偿：对长段落采用重叠窗口（如 512-1024 tokens，步长 256-512）减低截断信息损失
   - 层次索引：chunk与父章节/文档建立层级关联，便于回溯上文与整段输出
   - 词法索引：Elasticsearch建立倒排索引，支持BM25与字段权重配置
   - 语义索引：向量库（Qdrant/Milvus）存储嵌入与元数据（学期、课程、流程类型、版本）

2) 嵌入模型（Embedding）
   - 首选：bge-m3（多语多功能，支持dense/sparse混合，中文效果优良，开源可自托管）
   - 备选：Qwen-embeddings（阿里生态友好）、jina-embeddings-v3（多语表现稳健）
   - 选择理由：
     - 中文语义召回质量稳定；支持较大上下文；社区成熟度与资源丰富
     - 开源可控，成本可优化；兼容云端API落地（如百炼提供的向量服务）

3) 混合检索策略
   - 候选生成：
     - BM25@TopK_s（如 K=30）与Dense@TopK_d（如 K=30）并行召回
   - 融合与初筛：
     - 归一化分数 + 权重融合（dense_weight≈0.6, sparse_weight≈0.4）
     - 元数据过滤（domain=SE，semester=当前，course=用户偏好）
   - 重排（Rerank）：
     - 交叉编码器：bge-reranker-v2-m3 或 Cohere Rerank（如可用）
     - 策略：TopN重排（如 TopN=10），相似片段去重；MMR（最大边际相关）避免冗余

4) 过滤与安全
   - 过滤维度：版本（latest/stable）、流程类型、课程/项目、可见范围（权限）
   - 脱敏：在采集与输出阶段对PII与敏感字段进行脱敏；保留可审计原文档链接

三、数据流程（实现细节）
步骤示例：
1) 采集：
   - 扫描目录/云盘/网页；对PDF/图片执行OCR；抽取标题与目录结构
   - 生成元数据：source、semester、course、type、version、published_at
2) 分块与清洗：
   - 结构化分块 + 滑窗；清洗空白/噪声；保留章节路径
3) 嵌入与索引：
   - 生成dense/sparse嵌入；写入Qdrant（payload含元数据与层级信息）；写入Elasticsearch（倒排与字段权重）
4) 检索：
   - 根据查询与会话上下文，执行BM25与向量检索；融合分数；过滤；产出候选
5) 重排与答案生成：
   - 交叉编码器重排，取TopN；拼接上下文；模型生成回答与引用；工具链触发（如模板/日程）
6) 记忆更新：
   - 将关键问答摘要写入长期记忆（主题桶），更新会话短期记忆窗口

四、长期记忆（Memory）
- 短期：最近消息窗口（如 20 条），会话要点摘要以减少上下文长度
- 长期：
  - 语义摘要：将关键对话聚合为简短语义向量 + 文本摘要
  - 主题分桶：基于聚类（KMeans/HNSW近邻）按课程/流程主题归档
  - 时间衰减：近30天权重更高；过旧记忆归档但可检索
  - 个性化：用户偏好（课程/项目/角色）作为检索过滤与重排特征

五、工具插件与MCP
- MCP（Model Context Protocol）：统一工具与记忆接口，便于跨平台调用与安全隔离
- 工具示例：
  - 模板中心：根据检索结果直接提供相关模板下载链接
  - 清单生成：将回答转为Checklist，支持导出CSV/Markdown
  - 日程与提醒：创建截止日期日程，推送到企业协作平台机器人
  - 文档校验：对上传文档执行结构/格式检查（章节/引用/页眉页脚），输出改进建议
  - 外部集成：Git/Jira/飞书/钉钉/企业微信；通过MCP适配器管理凭证与权限

六、DSL设计（示例与说明）
- 目标：以DSL定义端到端工作流：数据源、索引、检索、重排与过滤、工具链、记忆、发布
- 语法：YAML（便于阅读与平台集成）

示例：se_agent.dsl.yaml（提交将包含实际文件）
version: 1
agent:
  name: NJU-SE-Agent
  model: qwen2-72b-instruct
retrieval:
  embedder: bge-m3
  vector_store: qdrant
  hybrid:
    bm25: elasticsearch
    dense_weight: 0.6
    sparse_weight: 0.4
  rerank:
    model: bge-reranker-v2-m3
    top_k: 10
filter:
  include:
    - domain: SE
    - version: latest
memory:
  short_term:
    window: 20
  long_term:
    summarizer: map-reduce
    decay_days: 30
tools:
  - name: confluence_search
    type: mcp
  - name: git_ops
    type: mcp
publish:
  endpoints:
    - huawei
    - aliyun_bailian

七、API与对外调用
- REST接口（示例）：
  - POST /v1/ask { query, user_id, context_preferences }
  - POST /v1/checklist { topic, constraints }
  - POST /v1/calendar/create { title, due, assignees }
  - GET  /v1/docs/source?id=... （下载模板或原文档）
- 返回字段：answer、citations（source、section、version）、confidence、actions（tools触发结果）

八、部署与发布
1) 阿里云百炼（Bailian）
   - 步骤：
     - 创建智能体应用：配置模型、RAG资源（知识库/向量服务）、环境变量（密钥/索引地址）
     - 上传DSL与配置文件；绑定工具（MCP适配器/HTTP插件）
     - 配置发布信息（名称、描述、类目、可见范围）；提交审核与发布
     - 获取调用入口（Web、API Endpoint），写入“应用发布信息”文档

2) 华为平台（ModelArts/盘古大模型服务）
   - 步骤：
     - 创建AI应用或服务：配置推理模型与RAG检索资源（向量库/ES）
     - 通过工作流/管道整合DSL定义的流程（采集-索引-检索-重排-工具-记忆）
     - 设置鉴权与配额；开启监控与日志；完成发布与外部访问配置
     - 获取访问入口与API说明，写入“应用发布信息”文档

九、安全与合规
- 鉴权：API密钥/Token；平台侧权限与可见范围配置
- 数据治理：敏感字段脱敏；版权与引用合规；审计日志与访问记录
- 可靠性：限流与重试；熔断与降级（如仅返回检索引用，不触发工具）

十、监控与评测
- 指标：召回率/精确率、Top-k命中率、响应时间、工具成功率、引用覆盖率
- 离线评测：构建流程问答测试集（FAQ/流程条目），A/B比较不同嵌入与重排
- 线上观测：请求日志、错误分布、慢查询分析；定期回归测试与索引健康检查

十一、实现参数建议（可按数据规模调优）
- Chunk size：512-1024 tokens；overlap：256-512
- Dense TopK：30；BM25 TopK：30；融合后候选：≤50
- Rerank TopN：10；MMR λ：0.3-0.5
- 过滤：semester=当前、version=latest优先；课程/项目按用户偏好加权

十二、测试方案
- 单元测试：分块、嵌入、索引写入、融合与重排、过滤逻辑
- 集成测试：端到端问答、工具链调用、记忆更新、API鉴权
- 压力测试：并发 100-500 rps；观察P95/P99与工具失败率

十三、实施清单
- 完成数据采集与清洗脚本
- 构建索引（Qdrant/Elasticsearch）与嵌入生成流程
- 实现混合检索、重排与过滤模块
- 接入工具插件（MCP），实现模板/清单/日程/消息/校验
- 构建长期记忆与会话管理
- 编写DSL与编排执行器；完成平台发布配置
- 编写API与外部调用示例；完成监控与评测

十四、交付与文档
- 流程截图：UI与平台发布页
- DSL文件：se_agent.dsl.yaml
- RAG选型与实现细节：本技术文档
- 应用发布信息：平台名称、入口URL、版本、可见范围、鉴权说明

附注：
- 实际平台名称与入口URL将在发布完成后填充到“应用发布信息”。